name: Deploy to EC2

on:
  push:
    branches:
      - main  # ou a branch que você estiver usando

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Prepare SSH Key
        run: |
          echo "$EC2_PRIVATE_KEY" > /tmp/ec2_key.ppk
          chmod 600 /tmp/ec2_key.ppk

      - name: Create SSH directory
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

      - name: Add EC2 to known_hosts
        run: |
          ssh-keyscan -H 54.207.0.19 >> ~/.ssh/known_hosts

      - name: Sync files to EC2
        run: |
          # Sincronizar arquivos do repositório com o servidor EC2
          rsync -avz -e "ssh -i /tmp/ec2_key.ppk" ./ ubuntu@54.207.0.19:/var/www/seu_projeto

      - name: Build and run Docker container on EC2
        run: |
          ssh -i /tmp/ec2_key.ppk ubuntu@54.207.0.19 << 'EOF'
          cd /var/www/seu_projeto
          docker build -t my-deploy-image .
          docker run --rm my-deploy-image bash -c "rsync -avz ./ ubuntu@localhost:/var/www/seu_projeto && sudo systemctl restart nginx"
          EOF
